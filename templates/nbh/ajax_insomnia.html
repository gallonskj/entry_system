{% extends 'templates/index.html' %}
{% load static %}
{% load SelfDefinedFilter%}
{% block title %}失眠严重指数量表{% endblock %}
{% block css %}
<link href="{% static '/css/scales_style.css' %}" rel="stylesheet">
{% endblock %}
{% block content %}
<div class="modal fade" id="exit_confirm" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <h4 align="center"> 您确认要退出当前自评量表测评吗？</h4>
            <div align="center">
                <button type="button"
                        onclick="location='/scales/select_scales?patient_session_id={{ patient_session_id }}&patient_id={{ patient_id }}&session_id={{ session_id }}'"
                        class="btn btn-danger" style="width:68px;height:34px">退出
                </button>
                <button type="button" class="btn btn-success" style="width:68px;height:34px" data-dismiss="modal">关闭
                </button>
            </div>
        </div>
    </div>
</div>
<div class="right_col" role="main">
    <div class="container">
        <div class="row show-grid">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <ul class="breadcrumb" style="background-color: white;font-weight:bold">
                    <li>量表录入</li>
                    <li>自评量表</li>
                    <li class="active">失眠严重指数量表</li>
                    <div style="float: right;margin-bottom: 0;"></div>
                </ul>
            </div>
        </div>
    </div>
    <div class="dashboard_graph x_panel" style="margin-top: 0;height:80%;">
        <div class="row" style="margin-left:5px;margin-top: 5px;padding-bottom: 5px;">
            <div align="center" style="padding-left: 22.5%; padding-right: 22.5%">
                <h5>
                    <strong>
                        <i class="fa fa-hand-o-down"></i>&nbsp;
                        <i class="fa fa-hand-o-down"></i>&nbsp;
                        <i class="fa fa-hand-o-down"></i>&nbsp;
                        指导语：请评估你过去两个星期睡眠问题的严重程度。
                    </strong>
                </h5>
            </div>
        </div>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        {% csrf_token %}
        <div class="question_area" name="question_area" style="text-align: center">
            <form id="question_form" name="question_form" action="#">
                <h3>
                    <div name="question_text" id="question_text" class="row">a.入睡困难</div>
                </h3>
                <table align="center">
                    <tr>
                        <td id="label_1" width="60px" align="center">没有</td>
                        <td id="label_2" width="60px" align="center">轻微</td>
                        <td id="label_3" width="60px" align="center">普通</td>
                        <td id="label_4" width="60px" align="center">严重</td>
                        <td id="label_5" width="70px" align="center">非常严重</td>
                    </tr>
                </table>
                <div class="options" style=" text-align: left;padding-left: 41.4%">

                    <div class="row show-grid" style="margin:10px">
                        <label>
                            <input type="range" min="0" max="4" step="1" style="width: 200%" class="answer"
                                   name="question1_answer" list="tickmarks"/>
                            <datalist id="tickmarks">
                                <option value="0"></option>
                                <option value="1"></option>
                                <option value="2"></option>
                                <option value="3"></option>
                                <option value="4"></option>
                            </datalist>
                        </label>
                    </div>
                </div>
                <div>
                    <input id="question_submit" type="button" class="btn btn-success text-center"
                           style="width:68px;height:34px" value="下一题">
                    <input type="button" class="btn btn-danger text-center exit_button" style="width:68px;height:34px"
                           value="退&nbsp;&nbsp;出">
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script type="text/javascript" src="{% static '/js/jquery-radio-beauty.js'%}"></script>
<script>
    // dom加载完毕
    const $m_btn = $('.exit_button');
    const $modal = $('#exit_confirm');
    $m_btn.on('click', function () {
        $modal.modal({backdrop: 'static'});
    });

    // 测试 bootstrap 居中
    $modal.on('show.bs.modal', function () {
        const $this = $(this);
        const $modal_dialog = $this.find('.modal-dialog');
        // 关键代码，如没将modal设置为 block，则$modala_dialog.height() 为零
        $this.css('display', 'block');
        $modal_dialog.css({'margin-top': Math.max(0, ($(window).height() - $modal_dialog.height()) / 2)});
    });
    let time = new Date();
    let suicide = false;
    let question_index = 1 + {{ question_index }};
    let end_flag = 0;
    for (let index = 1; index < question_index; index++) {
        update_question(index);
    }
    $(document).ready(function () {
        $("input[type='radio']").labelauty();
        $("#question_submit").on('click', function () {
            if (question_index > 7) {
                alert("请不要重复提交！");
            } else {
                ajax_post($('#question_form'));
                update_question(question_index);
                const input_range = document.getElementsByClassName('answer')[0];
                input_range.value = 2;
                question_index++;
            }
        });
    });

    function get_duration() {
        const current_time = new Date();
        const duration = time - current_time;
        time = current_time;
        return -duration;
    }

    function alter_option_names(option_class_name, name) {
        const nodes = document.getElementsByClassName(option_class_name);
        for (let i = 0; i < nodes.length; i++) {
            nodes[i].setAttribute("name", name);
        }
    }

    function alter_label_names(name_1, name_2, name_3, name_4, name_5) {
        const nodes_1 = document.getElementById('label_1');
        nodes_1.innerHTML = name_1;
        const nodes_2 = document.getElementById('label_2');
        nodes_2.innerHTML = name_2;
        const nodes_3 = document.getElementById('label_3');
        nodes_3.innerHTML = name_3;
        const nodes_4 = document.getElementById('label_4');
        nodes_4.innerHTML = name_4;
        const nodes_5 = document.getElementById('label_5');
        nodes_5.innerHTML = name_5
        ;
    }

    function update_question(index) {
        switch (index) {
            case 1:
                document.getElementById('question_text').innerHTML = "b.难以维持睡眠";
                alter_option_names("answer", "question2_answer");
                break;
            case 2:
                document.getElementById('question_text').innerHTML = "c.太早就醒了的问题";
                alter_option_names("answer", "question3_answer");
                alter_label_names("非常满意", "", "", "", "非常不满意");
                document.getElementById('label_1').setAttribute('width', '80px')
                document.getElementById('label_5').setAttribute('width', '80px')
                break;
            case 3:
                document.getElementById('question_text').innerHTML = "d.你对过去两个星期的睡眠状况满意度如何";
                alter_option_names("answer", "question4_answer");
                alter_label_names("完全没有妨碍", "少许", "颇为", "非常", "极之妨碍");
                document.getElementById('label_1').setAttribute('width', '100px')
                break;
            case 4:
                document.getElementById('question_text').innerHTML = "e.你认为你的睡眠问题妨碍你日常运作（例如：日渐疲劳、处理工作/日常时务的能力、集中力、记忆、情绪等等）到哪一个程度？";
                alter_option_names("answer", "question5_answer");
                alter_label_names("完全不明显", "仅为", "颇为", "非常", "极之明显");
                break;
            case 5:
                document.getElementById('question_text').innerHTML = "f.你的睡眠问题在降低生活素质而言，在其他人眼中有多明显？";
                alter_option_names("answer", "question6_answer");
                alter_label_names("完全没有", "少许", "颇为", "非常", "非常大");
                break;
            case 6:
                document.getElementById('question_text').innerHTML = "g.你对你现时的睡眠问题有多忧虑/苦恼？";
                alter_option_names("answer", "question7_answer");
                // 跳转
                document.getElementById('question_submit').setAttribute('onclick', "location=\'" +
                    "/scales/get_next_self_scale_url?patient_session_id={{ patient_session_id }}&patient_id={{ patient_id }}&scale_id={{ scale_id }}" +
                    "\'"
                );
                end_flag = 1;
                break;
        }
    }

    function ajax_post(form) {
        const csrf = $('input[name="csrfmiddlewaretoken"]').val();
        $.ajax({
            url: 'http://' + location.host +
                '/scales/self_tests_submit?patient_session_id={{ patient_session_id }}&patient_id={{ patient_id }}&scale_id={{ scale_id }}',
            type: 'POST',
            dataType: 'JSON',
            async: true,
            data: {
                'data': form.serialize(),
                'question_index': question_index,
                'duration': get_duration(),
                'test_name': 'insomnia',
                'flag': end_flag,
                'csrfmiddlewaretoken': csrf
            }
        })
    }

</script>

{% endblock %}